# Makefile for ç¬¬3ç« ï¼šæ ‘å’ŒäºŒå‰æ ‘
# create by: zw.duan

# ç¼–è¯‘å™¨è®¾ç½®
CC = gcc
CFLAGS = -std=c99 -Wall -Wextra -g -O2
DEBUGFLAGS = -DDEBUG -g -O0
INCLUDES = -I.

# ç›®å½•è®¾ç½®
BUILDDIR = ../../../build/3.æ ‘å’ŒäºŒå‰æ ‘
OBJDIR = $(BUILDDIR)/obj
BINDIR = $(BUILDDIR)/bin

# æºæ–‡ä»¶
SOURCES = bintree.c bst.c rbtree.c heap.c unionfind.c huffman.c btree.c
HEADERS = bintree.h bst.h rbtree.h heap.h unionfind.h huffman.h btree.h bplustree.h  
TEST_SOURCES = test_bintree.c test_bst.c test_rbtree.c test_heap.c test_unionfind.c test_huffman.c test_btree.c

# ç›®æ ‡æ–‡ä»¶
OBJECTS = $(SOURCES:%.c=$(OBJDIR)/%.o)
TEST_OBJECTS = $(TEST_SOURCES:%.c=$(OBJDIR)/%.o)

# å¯æ‰§è¡Œæ–‡ä»¶
EXECUTABLES = $(BINDIR)/test_bintree $(BINDIR)/test_bst $(BINDIR)/test_rbtree $(BINDIR)/test_heap $(BINDIR)/test_unionfind $(BINDIR)/test_huffman $(BINDIR)/test_btree

# é¢œè‰²å®šä¹‰
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[0;33m
BLUE = \033[0;34m
PURPLE = \033[0;35m
CYAN = \033[0;36m
NC = \033[0m # No Color

# ============= ä¸»è¦ç›®æ ‡ =============

.PHONY: all clean help test run install debug format info

# é»˜è®¤ç›®æ ‡ï¼šæ„å»ºæ‰€æœ‰æµ‹è¯•ç¨‹åº
all: directories $(EXECUTABLES)
	@echo "$(GREEN)âœ… ç¬¬3ç« æ‰€æœ‰ç¨‹åºç¼–è¯‘å®Œæˆï¼$(NC)"
	@echo "$(CYAN)ğŸ“ è¾“å‡ºç›®å½•: $(BUILDDIR)$(NC)"

# åˆ›å»ºå¿…è¦çš„ç›®å½•
directories:
	@mkdir -p $(OBJDIR) $(BINDIR)

# ============= å•ç‹¬ç¼–è¯‘è§„åˆ™ =============

# ç¼–è¯‘äºŒå‰æ ‘æµ‹è¯•ç¨‹åº
$(BINDIR)/test_bintree: $(OBJDIR)/bintree.o $(OBJDIR)/test_bintree.o
	@echo "$(BLUE)ğŸ”— é“¾æ¥äºŒå‰æ ‘æµ‹è¯•ç¨‹åº...$(NC)"
	$(CC) $(CFLAGS) $^ -o $@
	@echo "$(GREEN)âœ… test_bintree ç¼–è¯‘å®Œæˆ$(NC)"

# ç¼–è¯‘äºŒå‰æœç´¢æ ‘æµ‹è¯•ç¨‹åº
$(BINDIR)/test_bst: $(OBJDIR)/bst.o $(OBJDIR)/test_bst.o
	@echo "$(BLUE)ğŸ”— é“¾æ¥äºŒå‰æœç´¢æ ‘æµ‹è¯•ç¨‹åº...$(NC)"
	$(CC) $(CFLAGS) $^ -o $@
	@echo "$(GREEN)âœ… test_bst ç¼–è¯‘å®Œæˆ$(NC)"

# ç¼–è¯‘çº¢é»‘æ ‘æµ‹è¯•ç¨‹åº
$(BINDIR)/test_rbtree: $(OBJDIR)/rbtree.o $(OBJDIR)/test_rbtree.o
	@echo "$(BLUE)ğŸ”— é“¾æ¥çº¢é»‘æ ‘æµ‹è¯•ç¨‹åº...$(NC)"
	$(CC) $(CFLAGS) $^ -o $@
	@echo "$(GREEN)âœ… test_rbtree ç¼–è¯‘å®Œæˆ$(NC)"

# ç¼–è¯‘å †æµ‹è¯•ç¨‹åº
$(BINDIR)/test_heap: $(OBJDIR)/heap.o $(OBJDIR)/test_heap.o
	@echo "$(BLUE)ğŸ”— é“¾æ¥å †æµ‹è¯•ç¨‹åº...$(NC)"
	$(CC) $(CFLAGS) $^ -o $@
	@echo "$(GREEN)âœ… test_heap ç¼–è¯‘å®Œæˆ$(NC)"

# ç¼–è¯‘å¹¶æŸ¥é›†æµ‹è¯•ç¨‹åº
$(BINDIR)/test_unionfind: $(OBJDIR)/unionfind.o $(OBJDIR)/test_unionfind.o
	@echo "$(BLUE)ğŸ”— é“¾æ¥å¹¶æŸ¥é›†æµ‹è¯•ç¨‹åº...$(NC)"
	$(CC) $(CFLAGS) $^ -o $@
	@echo "$(GREEN)âœ… test_unionfind ç¼–è¯‘å®Œæˆ$(NC)"

# ç¼–è¯‘å“ˆå¤«æ›¼æ ‘æµ‹è¯•ç¨‹åº
$(BINDIR)/test_huffman: $(OBJDIR)/huffman.o $(OBJDIR)/test_huffman.o
	@echo "$(BLUE)ğŸ”— é“¾æ¥å“ˆå¤«æ›¼æ ‘æµ‹è¯•ç¨‹åº...$(NC)"
	$(CC) $(CFLAGS) $^ -o $@
	@echo "$(GREEN)âœ… test_huffman ç¼–è¯‘å®Œæˆ$(NC)"

# ç¼–è¯‘Bæ ‘æµ‹è¯•ç¨‹åº
$(BINDIR)/test_btree: $(OBJDIR)/btree.o $(OBJDIR)/test_btree.o
	@echo "$(BLUE)ğŸ”— é“¾æ¥Bæ ‘æµ‹è¯•ç¨‹åº...$(NC)"
	$(CC) $(CFLAGS) $^ -o $@
	@echo "$(GREEN)âœ… test_btree ç¼–è¯‘å®Œæˆ$(NC)"





# ============= ç›®æ ‡æ–‡ä»¶ç¼–è¯‘è§„åˆ™ =============

$(OBJDIR)/%.o: %.c $(HEADERS)
	@echo "$(YELLOW)ğŸ”¨ ç¼–è¯‘ $<...$(NC)"
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# ============= æµ‹è¯•è¿è¡Œ =============

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test: all
	@echo "$(PURPLE)ğŸ§ª è¿è¡Œæ‰€æœ‰æ ‘æ•°æ®ç»“æ„æµ‹è¯•...$(NC)"
	@echo "$(CYAN)==================== äºŒå‰æ ‘æµ‹è¯• ====================$(NC)"
	@if [ -f $(BINDIR)/test_bintree ]; then $(BINDIR)/test_bintree; fi
	@echo "$(CYAN)================== äºŒå‰æœç´¢æ ‘æµ‹è¯• ==================$(NC)"
	@if [ -f $(BINDIR)/test_bst ]; then $(BINDIR)/test_bst; fi
	@echo "$(CYAN)==================== çº¢é»‘æ ‘æµ‹è¯• ====================$(NC)"
	@if [ -f $(BINDIR)/test_rbtree ]; then $(BINDIR)/test_rbtree; fi
	@echo "$(CYAN)===================== å †æµ‹è¯• =====================$(NC)"
	@if [ -f $(BINDIR)/test_heap ]; then $(BINDIR)/test_heap; fi
	@echo "$(CYAN)=================== å¹¶æŸ¥é›†æµ‹è¯• ====================$(NC)"
	@if [ -f $(BINDIR)/test_unionfind ]; then $(BINDIR)/test_unionfind; fi
	@echo "$(CYAN)================== å“ˆå¤«æ›¼æ ‘æµ‹è¯• ===================$(NC)"
	@if [ -f $(BINDIR)/test_huffman ]; then $(BINDIR)/test_huffman; fi
	@echo "$(CYAN)==================== Bæ ‘æµ‹è¯• =====================$(NC)"
	@if [ -f $(BINDIR)/test_btree ]; then $(BINDIR)/test_btree; fi

# è¿è¡Œå•ä¸ªæµ‹è¯•
test-bintree: $(BINDIR)/test_bintree
	@echo "$(PURPLE)ğŸ§ª è¿è¡ŒäºŒå‰æ ‘æµ‹è¯•...$(NC)"
	$(BINDIR)/test_bintree

test-bst: $(BINDIR)/test_bst
	@echo "$(PURPLE)ğŸ§ª è¿è¡ŒäºŒå‰æœç´¢æ ‘æµ‹è¯•...$(NC)"
	$(BINDIR)/test_bst

test-rbtree: $(BINDIR)/test_rbtree
	@echo "$(PURPLE)ğŸ§ª è¿è¡Œçº¢é»‘æ ‘æµ‹è¯•...$(NC)"
	$(BINDIR)/test_rbtree

test-heap: $(BINDIR)/test_heap
	@echo "$(PURPLE)ğŸ§ª è¿è¡Œå †æµ‹è¯•...$(NC)"
	$(BINDIR)/test_heap

test-unionfind: $(BINDIR)/test_unionfind
	@echo "$(PURPLE)ğŸ§ª è¿è¡Œå¹¶æŸ¥é›†æµ‹è¯•...$(NC)"
	$(BINDIR)/test_unionfind

test-huffman: $(BINDIR)/test_huffman
	@echo "$(PURPLE)ğŸ§ª è¿è¡Œå“ˆå¤«æ›¼æ ‘æµ‹è¯•...$(NC)"
	$(BINDIR)/test_huffman

test-btree: $(BINDIR)/test_btree
	@echo "$(PURPLE)ğŸ§ª è¿è¡ŒBæ ‘æµ‹è¯•...$(NC)"
	$(BINDIR)/test_btree

# ============= è°ƒè¯•ç‰ˆæœ¬ =============

debug: CFLAGS += $(DEBUGFLAGS)
debug: clean all
	@echo "$(YELLOW)ğŸ› è°ƒè¯•ç‰ˆæœ¬ç¼–è¯‘å®Œæˆ$(NC)"

# ä½¿ç”¨gdbè°ƒè¯•
gdb-bintree: debug
	gdb $(BINDIR)/test_bintree

gdb-bst: debug
	gdb $(BINDIR)/test_bst

gdb-rbtree: debug
	gdb $(BINDIR)/test_rbtree

gdb-heap: debug
	gdb $(BINDIR)/test_heap

# ============= å†…å­˜æ£€æŸ¥ =============

# ä½¿ç”¨valgrindæ£€æŸ¥å†…å­˜æ³„æ¼
valgrind: all
	@echo "$(PURPLE) ä½¿ç”¨Valgrindæ£€æŸ¥å†…å­˜...$(NC)"
	@if command -v valgrind >/dev/null 2>&1; then \
		valgrind --leak-check=full --show-leak-kinds=all $(BINDIR)/test_bintree; \
	else \
		echo "$(RED)âŒ Valgrindæœªå®‰è£…$(NC)"; \
	fi

# ============= æ€§èƒ½æµ‹è¯• =============

# æ€§èƒ½åŸºå‡†æµ‹è¯•
benchmark: all
	@echo "$(PURPLE)âš¡ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•...$(NC)"
	@echo "æµ‹è¯•ç¯å¢ƒ: $$(uname -a)"
	@echo "ç¼–è¯‘å™¨ç‰ˆæœ¬: $$($(CC) --version | head -1)"
	@echo "ç¼–è¯‘é€‰é¡¹: $(CFLAGS)"
	@echo "å¼€å§‹æ€§èƒ½æµ‹è¯•..."
	@for exec in $(EXECUTABLES); do \
		if [ -f $$exec ]; then \
			echo "$(CYAN)æµ‹è¯• $$exec$(NC)"; \
			time $$exec >/dev/null; \
		fi; \
	done

# ============= ä»£ç è´¨é‡ =============

# ä»£ç æ ¼å¼åŒ–ï¼ˆå¦‚æœå®‰è£…äº†clang-formatï¼‰
format:
	@if command -v clang-format >/dev/null 2>&1; then \
		echo "$(BLUE)ğŸ¨ æ ¼å¼åŒ–ä»£ç ...$(NC)"; \
		clang-format -i *.c *.h; \
		echo "$(GREEN)âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  clang-formatæœªå®‰è£…ï¼Œè·³è¿‡æ ¼å¼åŒ–$(NC)"; \
	fi

# é™æ€ä»£ç åˆ†æ
analyze:
	@if command -v cppcheck >/dev/null 2>&1; then \
		echo "$(BLUE) è¿è¡Œé™æ€ä»£ç åˆ†æ...$(NC)"; \
		cppcheck --enable=all --std=c99 *.c; \
	else \
		echo "$(YELLOW)âš ï¸  cppcheckæœªå®‰è£…ï¼Œè·³è¿‡é™æ€åˆ†æ$(NC)"; \
	fi

# ============= ä¿¡æ¯å’Œå¸®åŠ© =============

# æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
info:
	@echo "$(CYAN)==================== é¡¹ç›®ä¿¡æ¯ ====================$(NC)"
	@echo "ğŸ“‚ é¡¹ç›®:   ç¬¬3ç«  æ ‘å’ŒäºŒå‰æ ‘"
	@echo "ğŸ‘¨â€ğŸ’» ä½œè€…: zw.duan"
	@echo "ğŸ“… åˆ›å»º: $$(date '+%Y-%m-%d')"
	@echo ""
	@echo "$(BLUE)ğŸ“‹ åŒ…å«çš„æ•°æ®ç»“æ„:$(NC)"
	@echo "  â€¢ äºŒå‰æ ‘ (bintree.c/h) - åŸºæœ¬äºŒå‰æ ‘æ“ä½œ"
	@echo "  â€¢ äºŒå‰æœç´¢æ ‘ (bst.c/h) - BSTçš„å„ç§æ“ä½œ"
	@echo "  â€¢ çº¢é»‘æ ‘ (rbtree.c/h) - è‡ªå¹³è¡¡äºŒå‰æœç´¢æ ‘"
	@echo "  â€¢ å † (heap.c/h) - æœ€å¤§å †å’Œæœ€å°å †"
	@echo "  â€¢ å¹¶æŸ¥é›† (unionfind.c/h) - è·¯å¾„å‹ç¼©å’ŒæŒ‰ç§©åˆå¹¶"
	@echo "  â€¢ å“ˆå¤«æ›¼æ ‘ (huffman.c/h) - æœ€ä¼˜ç¼–ç æ ‘å’Œæ•°æ®å‹ç¼©"
	@echo ""
	@echo "$(BLUE)ğŸ—ï¸  æ„å»ºä¿¡æ¯:$(NC)"
	@echo "  ç¼–è¯‘å™¨: $(CC)"
	@echo "  ç¼–è¯‘é€‰é¡¹: $(CFLAGS)"
	@echo "  è¾“å‡ºç›®å½•: $(BUILDDIR)"
	@echo ""
	@echo "$(BLUE)  ä»£ç ç»Ÿè®¡:$(NC)"
	@if command -v wc >/dev/null 2>&1; then \
		echo "  æºæ–‡ä»¶æ•°: $$(ls -1 *.c 2>/dev/null | wc -l)"; \
		echo "  å¤´æ–‡ä»¶æ•°: $$(ls -1 *.h 2>/dev/null | wc -l)"; \
		echo "  æ€»è¡Œæ•°: $$(cat *.c *.h 2>/dev/null | wc -l)"; \
	fi

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "$(CYAN)==================== ä½¿ç”¨å¸®åŠ© ====================$(NC)"
	@echo ""
	@echo "$(GREEN) ä¸»è¦ç›®æ ‡:$(NC)"
	@echo "  all         - ç¼–è¯‘æ‰€æœ‰ç¨‹åºï¼ˆé»˜è®¤ï¼‰"
	@echo "  clean       - æ¸…ç†æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶"
	@echo "  test        - è¿è¡Œæ‰€æœ‰æµ‹è¯•ç¨‹åº"
	@echo "  debug       - ç¼–è¯‘è°ƒè¯•ç‰ˆæœ¬"
	@echo "  help        - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "$(GREEN)ğŸ§ª æµ‹è¯•ç›®æ ‡:$(NC)"
	@echo "  test-bintree   - è¿è¡ŒäºŒå‰æ ‘æµ‹è¯•"
	@echo "  test-bst       - è¿è¡ŒäºŒå‰æœç´¢æ ‘æµ‹è¯•"
	@echo "  test-rbtree    - è¿è¡Œçº¢é»‘æ ‘æµ‹è¯•"
	@echo "  test-heap      - è¿è¡Œå †æµ‹è¯•"
	@echo ""
	@echo "$(GREEN)ğŸ› è°ƒè¯•ç›®æ ‡:$(NC)"
	@echo "  debug          - ç¼–è¯‘è°ƒè¯•ç‰ˆæœ¬"
	@echo "  gdb-bintree    - ä½¿ç”¨GDBè°ƒè¯•äºŒå‰æ ‘"
	@echo "  gdb-bst        - ä½¿ç”¨GDBè°ƒè¯•äºŒå‰æœç´¢æ ‘"
	@echo "  gdb-rbtree     - ä½¿ç”¨GDBè°ƒè¯•çº¢é»‘æ ‘"
	@echo "  gdb-heap       - ä½¿ç”¨GDBè°ƒè¯•å †"
	@echo "  valgrind       - ä½¿ç”¨Valgrindæ£€æŸ¥å†…å­˜"
	@echo ""
	@echo "$(GREEN)âš¡ æ€§èƒ½å’Œè´¨é‡:$(NC)"
	@echo "  benchmark      - è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•"
	@echo "  format         - æ ¼å¼åŒ–ä»£ç "
	@echo "  analyze        - é™æ€ä»£ç åˆ†æ"
	@echo ""
	@echo "$(GREEN)â„¹ï¸  ä¿¡æ¯:$(NC)"
	@echo "  info           - æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯"

# ============= æ¸…ç† =============

clean:
	@echo "$(RED)ğŸ§¹ æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶...$(NC)"
	@rm -rf $(BUILDDIR)
	@rm -f *.o *~ core.*
	@echo "$(GREEN)âœ… æ¸…ç†å®Œæˆ$(NC)"

# ============= å®‰è£…æ£€æŸ¥ =============

install:
	@echo "$(BLUE)ğŸ”§ æ£€æŸ¥å¼€å‘ç¯å¢ƒ...$(NC)"
	@echo "æ£€æŸ¥å¿…éœ€çš„å·¥å…·:"
	@which $(CC) >/dev/null 2>&1 && echo "$(GREEN)âœ… $(CC) å·²å®‰è£…$(NC)" || echo "$(RED)âŒ $(CC) æœªå®‰è£…$(NC)"
	@which make >/dev/null 2>&1 && echo "$(GREEN)âœ… make å·²å®‰è£…$(NC)" || echo "$(RED)âŒ make æœªå®‰è£…$(NC)"
	@echo ""
	@echo "æ£€æŸ¥å¯é€‰å·¥å…·:"
	@which gdb >/dev/null 2>&1 && echo "$(GREEN)âœ… gdb å·²å®‰è£…$(NC)" || echo "$(YELLOW)âš ï¸  gdb æœªå®‰è£…ï¼ˆè°ƒè¯•åŠŸèƒ½å—é™ï¼‰$(NC)"
	@which valgrind >/dev/null 2>&1 && echo "$(GREEN)âœ… valgrind å·²å®‰è£…$(NC)" || echo "$(YELLOW)âš ï¸  valgrind æœªå®‰è£…ï¼ˆå†…å­˜æ£€æŸ¥åŠŸèƒ½å—é™ï¼‰$(NC)"
	@which clang-format >/dev/null 2>&1 && echo "$(GREEN)âœ… clang-format å·²å®‰è£…$(NC)" || echo "$(YELLOW)âš ï¸  clang-format æœªå®‰è£…ï¼ˆä»£ç æ ¼å¼åŒ–åŠŸèƒ½å—é™ï¼‰$(NC)"
	@which cppcheck >/dev/null 2>&1 && echo "$(GREEN)âœ… cppcheck å·²å®‰è£…$(NC)" || echo "$(YELLOW)âš ï¸  cppcheck æœªå®‰è£…ï¼ˆé™æ€åˆ†æåŠŸèƒ½å—é™ï¼‰$(NC)"

# ============= ä¾èµ–å…³ç³» =============

# ä¾èµ–å…³ç³»å£°æ˜
$(OBJDIR)/bintree.o: bintree.c bintree.h
$(OBJDIR)/bst.o: bst.c bst.h
$(OBJDIR)/rbtree.o: rbtree.c rbtree.h
$(OBJDIR)/heap.o: heap.c heap.h
$(OBJDIR)/btree.o: btree.c btree.h
$(OBJDIR)/test_bintree.o: test_bintree.c bintree.h
$(OBJDIR)/test_bst.o: test_bst.c bst.h
$(OBJDIR)/test_rbtree.o: test_rbtree.c rbtree.h
$(OBJDIR)/test_heap.o: test_heap.c heap.h
$(OBJDIR)/test_btree.o: test_btree.c btree.h

# é˜²æ­¢åˆ é™¤ä¸­é—´æ–‡ä»¶
.PRECIOUS: $(OBJDIR)/%.o

# å£°æ˜å‡ç›®æ ‡
.PHONY: directories test test-bintree test-bst test-rbtree test-heap debug \
        gdb-bintree gdb-bst gdb-rbtree gdb-heap valgrind benchmark \
        format analyze info help clean install 