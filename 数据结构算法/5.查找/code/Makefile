# Makefile for æŸ¥æ‰¾ç®—æ³•ç« èŠ‚
# create by: zw.duan

# ç¼–è¯‘å™¨è®¾ç½®
CC = gcc
CFLAGS = -std=c99 -Wall -Wextra -O2 -g
LDFLAGS = -lm

# ç›®å½•è®¾ç½®
TREE_DIR = ../../3.æ ‘å’ŒäºŒå‰æ ‘/code
BUILD_DIR = ../../build
OBJ_DIR = $(BUILD_DIR)/obj/5.æŸ¥æ‰¾
BIN_DIR = $(BUILD_DIR)/bin

# æºæ–‡ä»¶
SEARCH_SOURCES = search.c hashtable.c tree_search.c string_search.c
TEST_SOURCES = test_search.c test_hashtable.c test_string_search.c performance_test.c
ALL_SOURCES = $(SEARCH_SOURCES) $(TEST_SOURCES)

# ç›®æ ‡æ–‡ä»¶
SEARCH_OBJECTS = $(SEARCH_SOURCES:%.c=$(OBJ_DIR)/%.o)
TEST_OBJECTS = $(TEST_SOURCES:%.c=$(OBJ_DIR)/%.o)
ALL_OBJECTS = $(SEARCH_OBJECTS) $(TEST_OBJECTS)

# å¯æ‰§è¡Œæ–‡ä»¶
TARGETS = $(BIN_DIR)/test_search $(BIN_DIR)/test_hashtable $(BIN_DIR)/performance_test \
          $(BIN_DIR)/search_demo $(BIN_DIR)/hash_demo $(BIN_DIR)/test_string_search

# æ ‘ç»“æ„ä¾èµ–åº“
TREE_LIBS = $(BUILD_DIR)/lib/libbst.a $(BUILD_DIR)/lib/librbtree.a \
            $(BUILD_DIR)/lib/libbtree.a $(BUILD_DIR)/lib/libbplustree.a

# é»˜è®¤ç›®æ ‡
.PHONY: all clean test install help trees libs

all: dirs trees $(TARGETS)

# åˆ›å»ºç›®å½•
dirs:
	@mkdir -p $(OBJ_DIR)
	@mkdir -p $(BIN_DIR)
	@mkdir -p $(BUILD_DIR)/lib

# æ„å»ºä¾èµ–çš„æ ‘ç»“æ„
trees:
	@echo "ğŸŒ³ æ„å»ºæ ‘ç»“æ„ä¾èµ–..."
	@cd $(TREE_DIR) && $(MAKE) libs

# æ„å»ºé™æ€åº“
libs: $(BUILD_DIR)/lib/libsearch.a $(BUILD_DIR)/lib/libhashtable.a $(BUILD_DIR)/lib/libstring_search.a

$(BUILD_DIR)/lib/libsearch.a: $(OBJ_DIR)/search.o $(OBJ_DIR)/tree_search.o
	@echo "ğŸ“š åˆ›å»ºæŸ¥æ‰¾ç®—æ³•é™æ€åº“: $@"
	ar rcs $@ $^

$(BUILD_DIR)/lib/libhashtable.a: $(OBJ_DIR)/hashtable.o
	@echo "ğŸ“š åˆ›å»ºå“ˆå¸Œè¡¨é™æ€åº“: $@"
	ar rcs $@ $^

$(BUILD_DIR)/lib/libstring_search.a: $(OBJ_DIR)/string_search.o
	@echo "ğŸ“š åˆ›å»ºå­—ç¬¦ä¸²æœç´¢é™æ€åº“: $@"
	ar rcs $@ $^

# ============= ç¼–è¯‘è§„åˆ™ =============

# ç¼–è¯‘å¯¹è±¡æ–‡ä»¶
$(OBJ_DIR)/%.o: %.c
	@echo "ğŸ”¨ ç¼–è¯‘: $< â†’ $@"
	$(CC) $(CFLAGS) -I$(TREE_DIR) -c $< -o $@

# ============= å¯æ‰§è¡Œæ–‡ä»¶æ„å»º =============

# æŸ¥æ‰¾ç®—æ³•ç»¼åˆæµ‹è¯•
$(BIN_DIR)/test_search: $(OBJ_DIR)/test_search.o $(BUILD_DIR)/lib/libsearch.a $(TREE_LIBS)
	@echo " æ„å»ºæŸ¥æ‰¾ç®—æ³•æµ‹è¯•ç¨‹åº: $@"
	$(CC) $< -L$(BUILD_DIR)/lib -lsearch -lbst -lrbtree -lbtree -lbplustree $(LDFLAGS) -o $@

# å“ˆå¸Œè¡¨æµ‹è¯•
$(BIN_DIR)/test_hashtable: $(OBJ_DIR)/test_hashtable.o $(BUILD_DIR)/lib/libhashtable.a
	@echo " æ„å»ºå“ˆå¸Œè¡¨æµ‹è¯•ç¨‹åº: $@"
	$(CC) $< -L$(BUILD_DIR)/lib -lhashtable $(LDFLAGS) -o $@

# æ€§èƒ½æµ‹è¯•
$(BIN_DIR)/performance_test: $(OBJ_DIR)/performance_test.o $(BUILD_DIR)/lib/libsearch.a $(BUILD_DIR)/lib/libhashtable.a $(TREE_LIBS)
	@echo " æ„å»ºæ€§èƒ½æµ‹è¯•ç¨‹åº: $@"
	$(CC) $< -L$(BUILD_DIR)/lib -lsearch -lhashtable -lbst -lrbtree -lbtree -lbplustree $(LDFLAGS) -o $@

# æŸ¥æ‰¾ç®—æ³•æ¼”ç¤º
$(BIN_DIR)/search_demo: $(OBJ_DIR)/search_demo.o $(BUILD_DIR)/lib/libsearch.a $(TREE_LIBS)
	@echo " æ„å»ºæŸ¥æ‰¾ç®—æ³•æ¼”ç¤ºç¨‹åº: $@"
	$(CC) $< -L$(BUILD_DIR)/lib -lsearch -lbst -lrbtree -lbtree -lbplustree $(LDFLAGS) -o $@

# å“ˆå¸Œè¡¨æ¼”ç¤º
$(BIN_DIR)/hash_demo: $(OBJ_DIR)/hash_demo.o $(BUILD_DIR)/lib/libhashtable.a
	@echo " æ„å»ºå“ˆå¸Œè¡¨æ¼”ç¤ºç¨‹åº: $@"
	$(CC) $< -L$(BUILD_DIR)/lib -lhashtable $(LDFLAGS) -o $@

# å­—ç¬¦ä¸²æœç´¢æµ‹è¯•
$(BIN_DIR)/test_string_search: $(OBJ_DIR)/test_string_search.o $(BUILD_DIR)/lib/libstring_search.a
	@echo " æ„å»ºå­—ç¬¦ä¸²æœç´¢æµ‹è¯•ç¨‹åº: $@"
	$(CC) $< -L$(BUILD_DIR)/lib -lstring_search $(LDFLAGS) -o $@

# ============= æµ‹è¯•è§„åˆ™ =============

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test: all
	@echo "ğŸ§ª è¿è¡ŒæŸ¥æ‰¾ç®—æ³•æµ‹è¯•..."
	@echo "  åŸºæœ¬æŸ¥æ‰¾ç®—æ³•æµ‹è¯•ï¼š"
	$(BIN_DIR)/test_search
	@echo ""
	@echo "ğŸ”— å“ˆå¸Œè¡¨æµ‹è¯•ï¼š"
	$(BIN_DIR)/test_hashtable
	@echo ""
	@echo " å­—ç¬¦ä¸²æœç´¢æµ‹è¯•ï¼š"
	$(BIN_DIR)/test_string_search
	@echo ""
	@echo "âš¡ æ€§èƒ½å¯¹æ¯”æµ‹è¯•ï¼š"
	$(BIN_DIR)/performance_test

# è¿è¡ŒåŸºæœ¬æµ‹è¯•
test-basic: $(BIN_DIR)/test_search
	@echo "ğŸ§ª è¿è¡ŒåŸºæœ¬æŸ¥æ‰¾ç®—æ³•æµ‹è¯•..."
	$(BIN_DIR)/test_search

# ç®€å•ç¼–è¯‘æµ‹è¯•ï¼ˆä¸ä¾èµ–æ ‘ç»“æ„ï¼‰
test_search_simple: search.c test_search.c
	@echo "ğŸ”¨ ç®€å•ç¼–è¯‘æŸ¥æ‰¾ç®—æ³•æµ‹è¯•..."
	$(CC) $(CFLAGS) search.c test_search.c -o test_search_simple

# è¿è¡Œç®€å•æµ‹è¯•
run_simple: test_search_simple
	@echo "ğŸ§ª è¿è¡Œç®€å•æŸ¥æ‰¾ç®—æ³•æµ‹è¯•..."
	./test_search_simple

# è¿è¡Œå“ˆå¸Œè¡¨æµ‹è¯•
test-hash: $(BIN_DIR)/test_hashtable
	@echo "ğŸ§ª è¿è¡Œå“ˆå¸Œè¡¨æµ‹è¯•..."
	$(BIN_DIR)/test_hashtable

# è¿è¡Œå­—ç¬¦ä¸²æœç´¢æµ‹è¯•
test-string: $(BIN_DIR)/test_string_search
	@echo "ğŸ§ª è¿è¡Œå­—ç¬¦ä¸²æœç´¢æµ‹è¯•..."
	$(BIN_DIR)/test_string_search

# è¿è¡Œæ€§èƒ½æµ‹è¯•
test-performance: $(BIN_DIR)/performance_test
	@echo "ğŸ§ª è¿è¡Œæ€§èƒ½æµ‹è¯•..."
	$(BIN_DIR)/performance_test

# è¿è¡Œæ¼”ç¤ºç¨‹åº
demo: $(BIN_DIR)/search_demo $(BIN_DIR)/hash_demo
	@echo "ğŸª è¿è¡ŒæŸ¥æ‰¾ç®—æ³•æ¼”ç¤º..."
	$(BIN_DIR)/search_demo
	@echo ""
	@echo "ğŸª è¿è¡Œå“ˆå¸Œè¡¨æ¼”ç¤º..."
	$(BIN_DIR)/hash_demo

# ============= ä»£ç éªŒè¯ =============

# è¯­æ³•æ£€æŸ¥
check:
	@echo " è¿›è¡Œä»£ç è¯­æ³•æ£€æŸ¥..."
	@for file in $(ALL_SOURCES); do \
		if [ -f $$file ]; then \
			echo "æ£€æŸ¥: $$file"; \
			$(CC) $(CFLAGS) -I$(TREE_DIR) -fsyntax-only $$file; \
		fi \
	done

# å†…å­˜æ£€æŸ¥
memcheck: $(BIN_DIR)/test_search
	@echo "ğŸ§  è¿›è¡Œå†…å­˜æ³„æ¼æ£€æŸ¥..."
	@if command -v valgrind > /dev/null; then \
		valgrind --leak-check=full --show-leak-kinds=all $(BIN_DIR)/test_search; \
	else \
		echo "Valgrindæœªå®‰è£…ï¼Œè·³è¿‡å†…å­˜æ£€æŸ¥"; \
	fi

# ============= æ€§èƒ½åˆ†æ =============

# æ€§èƒ½åˆ†æ
profile: $(BIN_DIR)/performance_test
	@echo "  è¿›è¡Œæ€§èƒ½åˆ†æ..."
	@if command -v gprof > /dev/null; then \
		$(CC) $(CFLAGS) -pg $(OBJ_DIR)/performance_test.o -L$(BUILD_DIR)/lib -lsearch -lhashtable $(LDFLAGS) -o $(BIN_DIR)/performance_test_profile; \
		$(BIN_DIR)/performance_test_profile; \
		gprof $(BIN_DIR)/performance_test_profile gmon.out > performance_analysis.txt; \
		echo "æ€§èƒ½åˆ†æç»“æœä¿å­˜åˆ° performance_analysis.txt"; \
	else \
		echo "gprofæœªå®‰è£…ï¼Œè·³è¿‡æ€§èƒ½åˆ†æ"; \
	fi

# åŸºå‡†æµ‹è¯•
benchmark: $(BIN_DIR)/performance_test
	@echo "ğŸƒ è¿è¡ŒåŸºå‡†æµ‹è¯•..."
	@echo "æµ‹è¯•æ•°æ®è§„æ¨¡: 1000, 5000, 10000, 50000"
	$(BIN_DIR)/performance_test benchmark

# ============= ä»£ç ç»Ÿè®¡ =============

# ä»£ç ç»Ÿè®¡
stats:
	@echo "ğŸ“ˆ ä»£ç ç»Ÿè®¡ä¿¡æ¯ï¼š"
	@echo "æ–‡ä»¶æ•°é‡ï¼š"
	@find . -name "*.c" -o -name "*.h" | wc -l
	@echo "ä»£ç è¡Œæ•°ï¼š"
	@find . -name "*.c" -o -name "*.h" | xargs wc -l | tail -n 1
	@echo "å‡½æ•°æ•°é‡ï¼š"
	@grep -r "^[a-zA-Z_][a-zA-Z0-9_]*\s*(" *.c *.h 2>/dev/null | wc -l

# ============= æ¸…ç†è§„åˆ™ =============

# æ¸…ç†å¯¹è±¡æ–‡ä»¶
clean-obj:
	@echo "ğŸ§¹ æ¸…ç†å¯¹è±¡æ–‡ä»¶..."
	rm -rf $(OBJ_DIR)

# æ¸…ç†å¯æ‰§è¡Œæ–‡ä»¶
clean-bin:
	@echo "ğŸ§¹ æ¸…ç†å¯æ‰§è¡Œæ–‡ä»¶..."
	rm -f $(TARGETS)

# æ¸…ç†åº“æ–‡ä»¶
clean-lib:
	@echo "ğŸ§¹ æ¸…ç†åº“æ–‡ä»¶..."
	rm -f $(BUILD_DIR)/lib/libsearch.a $(BUILD_DIR)/lib/libhashtable.a

# å®Œå…¨æ¸…ç†
clean: clean-obj clean-bin clean-lib
	@echo "ğŸ§¹ æ¸…ç†å®Œæˆ"

# ============= å®‰è£…è§„åˆ™ =============

# å®‰è£…åˆ°ç³»ç»Ÿ
install: all
	@echo "ğŸ“¦ å®‰è£…æŸ¥æ‰¾ç®—æ³•åº“..."
	@mkdir -p /usr/local/include/search
	@mkdir -p /usr/local/lib
	@cp search.h hashtable.h /usr/local/include/search/
	@cp $(BUILD_DIR)/lib/libsearch.a $(BUILD_DIR)/lib/libhashtable.a /usr/local/lib/
	@echo "å®‰è£…å®Œæˆ"

# ============= æ–‡æ¡£ç”Ÿæˆ =============

# ç”Ÿæˆæ–‡æ¡£
docs:
	@echo "ğŸ“š ç”ŸæˆAPIæ–‡æ¡£..."
	@if command -v doxygen > /dev/null; then \
		doxygen Doxyfile; \
	else \
		echo "Doxygenæœªå®‰è£…ï¼Œè·³è¿‡æ–‡æ¡£ç”Ÿæˆ"; \
	fi

# ============= è°ƒè¯•è§„åˆ™ =============

# è°ƒè¯•ç‰ˆæœ¬
debug: CFLAGS += -DDEBUG -O0
debug: all

# GDBè°ƒè¯•
gdb: debug
	@echo "ğŸ› å¯åŠ¨GDBè°ƒè¯•..."
	gdb $(BIN_DIR)/test_search

# ============= å¸®åŠ©ä¿¡æ¯ =============

help:
	@echo "ğŸ“– æŸ¥æ‰¾ç®—æ³•ç« èŠ‚ Makefile ä½¿ç”¨è¯´æ˜"
	@echo ""
	@echo " ä¸»è¦ç›®æ ‡ï¼š"
	@echo "  all          - æ„å»ºæ‰€æœ‰ç¨‹åºå’Œåº“"
	@echo "  libs         - æ„å»ºé™æ€åº“"
	@echo "  test         - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  demo         - è¿è¡Œæ¼”ç¤ºç¨‹åº"
	@echo "  clean        - æ¸…ç†æ‰€æœ‰ç”Ÿæˆæ–‡ä»¶"
	@echo ""
	@echo "ğŸ§ª æµ‹è¯•ç›®æ ‡ï¼š"
	@echo "  test-basic   - åŸºæœ¬æŸ¥æ‰¾ç®—æ³•æµ‹è¯•"
	@echo "  test-hash    - å“ˆå¸Œè¡¨æµ‹è¯•"
	@echo "  test-performance - æ€§èƒ½æµ‹è¯•"
	@echo ""
	@echo " ä»£ç è´¨é‡ï¼š"
	@echo "  check        - è¯­æ³•æ£€æŸ¥"
	@echo "  memcheck     - å†…å­˜æ³„æ¼æ£€æŸ¥"
	@echo "  profile      - æ€§èƒ½åˆ†æ"
	@echo "  benchmark    - åŸºå‡†æµ‹è¯•"
	@echo ""
	@echo "  å…¶ä»–åŠŸèƒ½ï¼š"
	@echo "  stats        - ä»£ç ç»Ÿè®¡"
	@echo "  docs         - ç”Ÿæˆæ–‡æ¡£"
	@echo "  install      - å®‰è£…åˆ°ç³»ç»Ÿ"
	@echo "  debug        - è°ƒè¯•ç‰ˆæœ¬"
	@echo "  gdb          - GDBè°ƒè¯•"

# ============= ç‰¹æ®Šç›®æ ‡ =============

#  çœŸé¢˜æ¼”ç¤º
exam-demo: $(BIN_DIR)/search_demo
	@echo "ğŸ“  çœŸé¢˜æ¼”ç¤º..."
	$(BIN_DIR)/search_demo exam

# äº¤äº’å¼æ¼”ç¤º
interactive: $(BIN_DIR)/search_demo
	@echo "ğŸ® äº¤äº’å¼æŸ¥æ‰¾ç®—æ³•æ¼”ç¤º..."
	$(BIN_DIR)/search_demo interactive

# å¯è§†åŒ–æ¼”ç¤º
visual: $(BIN_DIR)/hash_demo
	@echo "ğŸ‘ï¸ å“ˆå¸Œè¡¨å¯è§†åŒ–æ¼”ç¤º..."
	$(BIN_DIR)/hash_demo visual

# ============= ä¾èµ–å…³ç³» =============

# ä¾èµ–å…³ç³»
$(OBJ_DIR)/search.o: search.c search.h $(TREE_DIR)/bst.h $(TREE_DIR)/rbtree.h $(TREE_DIR)/btree.h $(TREE_DIR)/bplustree.h
$(OBJ_DIR)/hashtable.o: hashtable.c hashtable.h
$(OBJ_DIR)/tree_search.o: tree_search.c search.h $(TREE_DIR)/bst.h $(TREE_DIR)/rbtree.h $(TREE_DIR)/btree.h $(TREE_DIR)/bplustree.h
$(OBJ_DIR)/string_search.o: string_search.c search.h
$(OBJ_DIR)/test_search.o: test_search.c search.h
$(OBJ_DIR)/test_hashtable.o: test_hashtable.c hashtable.h
$(OBJ_DIR)/performance_test.o: performance_test.c search.h hashtable.h

.PHONY: all clean test dirs trees libs install help stats docs debug gdb \
        test-basic test-hash test-performance demo exam-demo interactive visual \
        check memcheck profile benchmark clean-obj clean-bin clean-lib

# ================================
# ä½¿ç”¨è¯´æ˜ï¼š
# make          - æ„å»ºæ‰€æœ‰ç¨‹åº
# make test     - è¿è¡Œæ‰€æœ‰æµ‹è¯•
# make demo     - è¿è¡Œæ¼”ç¤ºç¨‹åº
# make help     - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
# ================================ 