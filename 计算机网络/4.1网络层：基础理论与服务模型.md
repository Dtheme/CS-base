# 4.1 网络层：基础理论与服务模型

## 目录

1. [重要性概览](#重要性概览)
2. [网络层概述](#网络层概述)
3. [虚电路和数据报网络](#虚电路和数据报网络)
4. [路由器工作原理](#路由器工作原理)
5. [Internet的网络层](#internet的网络层)
6. [典型例题解析](#典型例题解析)
7. [易错点分析](#易错点分析)


---

## 网络层概述

### 网络层服务

网络层为运输层提供服务。网络层协议存在于每台主机和路由器中。路由器检查通过它的所有IP数据报的头部字段，并根据头部字段将数据报从输入链路转移到输出链路。

> **网络层的核心功能**
> 
> 1. **转发(Forwarding)**：将分组从路由器的输入端口转移到输出端口
> 2. **路由选择(Routing)**：确定分组从源到目标主机的路径

### 转发和路由选择的关系

路由选择算法决定了插入路由器转发表中的内容，而转发是路由器的主要功能。

- **转发**是在单一路由器中的动作，将到达的分组从输入链路接口转移到输出链路接口
- **路由选择**涉及一个网络的所有路由器，它们通过路由选择协议相互协作

### 网络层提供的服务

网络层能够为发送主机和接收主机之间的分组交付提供什么样的服务呢？在发送主机注入一个分组进入网络层时，网络层是否保证该分组将到达目标主机？当多个分组发送时，它们是否按照发送的次序到达目标主机？相邻分组之间的到达时间间隔是否与它们发送时一样？网络是否提供任何关于网络中拥塞的反馈信息？

这些问题的答案取决于网络层提供的服务模型。

---

## 虚电路和数据报网络

网络层能够提供主机之间无连接服务或连接服务，但不会同时提供这两种服务。提供连接服务的计算机网络称为**虚电路(Virtual-Circuit, VC)网络**，提供无连接服务的计算机网络称为**数据报网络**。

### 虚电路网络

> **虚电路**
> 
> 从源主机到目标主机的一条路径，沿着这条路径，为这个网络层连接建立的状态存储在每台中间路由器中。

#### 虚电路网络的组成

一条虚电路包括：
1. 从源主机到目标主机的一条路径
2. VC号，沿着该路径的每段链路一个号码
3. 沿着该路径每台路由器中的转发表表项

#### 虚电路的三个阶段

1. **VC建立**：运输层与网络层联系，指定接收方地址，等待网络建立VC
2. **数据传输**：一旦建立VC，就可以开始传送分组
3. **VC拆除**：发送方或接收方通知网络终止该VC

#### 虚电路中的信令协议

用于VC的建立、维护和拆除的报文被称为**信令报文**，处理这些报文的协议被称为**信令协议**。

### 数据报网络

> **数据报网络**
> 
> 网络层不维持任何连接状态信息。当主机要发送分组时，它为该分组配上目标主机的地址，然后将分组推进网络中。

#### 数据报网络的特点

- **无连接**：每个分组都被独立地路由
- **无状态**：路由器不维护连接状态信息
- **尽力而为**：不保证分组的交付和顺序

#### 数据报转发

每台路由器有一个转发表，路由器使用分组的目标地址来索引该转发表，确定适当的输出链路。

**最长前缀匹配原则**：当寻找转发表表项时，使用最长前缀匹配规则，即在转发表中寻找最长的匹配项。

### 虚电路网络与数据报网络的起源

虚电路和数据报网络的概念分别借鉴了电话网络和邮政服务的思想：

- **虚电路网络**类似于电话网络：建立连接、传输数据、拆除连接
- **数据报网络**类似于邮政服务：每个分组独立处理，携带完整地址

---

## 路由器工作原理

### 路由器体系结构概述

> **路由器的组成**
> 
> 通用路由器体系结构包含4个组件：输入端口、交换结构、输出端口和路由选择处理器。

```
输入端口  →  交换结构  →  输出端口
    ↑                      ↓
    └── 路由选择处理器 ──────┘
```

#### 输入端口

**输入端口的功能**：
1. **物理层功能**：端接入链路
2. **链路层功能**：与位于入链路远端的数据链路层交互
3. **网络层功能**：查找转发表确定路由器的输出端口

**最重要功能**是执行查找功能，在此决定分组通过交换结构转发到哪个输出端口。

#### 交换结构

**交换结构**将路由器的输入端口与输出端口相连接。它完全包含在路由器之内，是一个网络路由器中的网络。

**三种交换技术**：

1. **经内存交换**：
   - 最简单、最早的路由器
   - 输入端口与输出端口之间的交换是在CPU直接控制下完成的

2. **经总线交换**：
   - 输入端口经一根共享总线将分组直接传送到输出端口
   - 不需要路由选择处理器的干预

3. **经互联网络交换**：
   - 使用更精细的互联网络
   - 当分组从端口A到达并需要转发到端口Y时，交换结构将分组传送到端口Y

#### 输出端口

**输出端口功能**：
1. 存储从交换结构接收的分组
2. 执行必要的链路层和物理层功能在输出链路上传输这些分组

**输出端口排队**：当分组从交换结构到达的速度超过输出速率时，就需要输出端口缓存。

#### 路由选择处理器

**路由选择处理器**执行控制平面功能：
- 执行路由选择协议
- 维护路由选择表与连接的链路状态信息
- 为该路由器计算转发表

### 输入端口处理和基于目标地址的转发

**输入端口的线路端接功能和数据链路处理**实现了用于该输入链路的物理层和数据链路层功能。

**查找功能**：输入端口还要执行查找功能，通过查询转发表决定分组将被转发到哪个输出端口。

**转发表的计算与更新**由路由选择处理器执行，但是转发表的副本通常存储在每个输入端口，这样就能在每个输入端口本地做出转发决定。

---

## Internet的网络层

Internet的网络层提供单一的服务，称为**尽力而为服务**。

> **尽力而为服务**
> 
> 使用尽力而为服务模型，不能保证分组的交付，不能保证分组的有序交付，不能保证分组交付的完整性。

### Internet网络层的组件

Internet的网络层有3个主要组件：

1. **IP协议**：定义数据报格式、分组处理规则
2. **路由选择协议**：决定数据报从源到目标主机的路径
3. **ICMP协议**：差错报告和网络探测功能

### 为什么Internet提供单一的无连接服务

这种设计选择基于以下考虑：

1. **简单性**：保持网络层的简单
2. **多样性**：适应各种类型的链路层技术
3. **去中心化**：避免网络层连接状态的复杂性

---

## 典型例题解析

### 例题4.1：虚电路与数据报网络对比

**题目**：比较虚电路网络和数据报网络在以下方面的特点：连接建立、寻址、状态信息、路由、故障影响。

**解析**：

| 比较项目 | 虚电路网络 | 数据报网络 |
|----------|------------|------------|
| 连接建立 | 需要建立虚电路 | 无需建立连接 |
| 寻址 | 每个分组携带短的VC标识符 | 每个分组携带完整的目标地址 |
| 状态信息 | 每个VC在路由器中维护状态 | 路由器中无连接状态信息 |
| 路由 | 路径在VC建立时确定，所有分组沿同一路径 | 每个分组独立路由 |
| 故障影响 | 路径上路由器故障影响所有经过的VC | 路由器故障时可选择其他路径 |

### 例题4.2：最长前缀匹配

**题目**：给定转发表如下，分组的目标地址为11001000 00010111 00010110 01100001，应选择哪个接口？

| 前缀匹配 | 接口 |
|----------|------|
| 11001000 00010111 00010*** | 0 |
| 11001000 00010111 00011000 | 1 |
| 11001000 00010111 00011*** | 2 |
| 否则 | 3 |

**解析**：

目标地址：11001000 00010111 00010110 01100001

与各表项匹配：
- 第1项：11001000 00010111 00010*** 匹配（前21位匹配）
- 第2项：11001000 00010111 00011000 不匹配
- 第3项：11001000 00010111 00011*** 不匹配

根据最长前缀匹配原则，选择接口0。

---

## 易错点分析

### 易错点1：转发与路由选择的区别

**易错理解**：认为转发和路由选择是同一个概念

**正确理解**：
- **转发**：局部动作，在单一路由器中将分组从输入端口移动到输出端口
- **路由选择**：全局动作，涉及网络中所有路由器协作确定路径

**记忆技巧**：转发看路由表，路由选择建路由表

### 易错点2：虚电路号的作用范围

**易错理解**：认为虚电路号在整个路径上保持不变

**正确理解**：虚电路号只在每条链路上有意义，可以在不同链路上使用不同的VC号

### 易错点3：数据报网络的"无连接"含义

**易错理解**：认为无连接意味着不可靠

**正确理解**：无连接是指网络层不维护连接状态，但上层协议（如TCP）可以提供可靠服务
 
---

**继续学习**：[4.2 路由算法与转发机制](4.2网络层：路由算法与转发机制.md)